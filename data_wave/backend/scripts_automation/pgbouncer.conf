# PgBouncer Configuration for Enterprise Data Governance Platform
# Optimized for high-concurrency web applications
# Prevents connection exhaustion and improves performance

[databases]
data_governance = host=data_governance_postgres port=5432 dbname=data_governance user=postgres password=postgres

[pgbouncer]
# Network settings
listen_addr = 0.0.0.0
listen_port = 6432
listen_backlog = 128
socket_dir = /tmp
unix_socket_dir = /tmp
unix_socket_mode = 0777

# Authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

# Connection pooling - Transaction mode for web apps
pool_mode = transaction
max_client_conn = 1000                    # Maximum client connections
default_pool_size = 50                    # Connections per database
min_pool_size = 10                        # Minimum connections
reserve_pool_size = 10                    # Reserve connections
reserve_pool_timeout = 5                  # Seconds to wait for reserve

# Connection timeouts
server_connect_timeout = 15               # Server connection timeout
server_login_retry = 15                   # Server login retry
query_timeout = 0                         # No query timeout
query_wait_timeout = 120                  # Wait for query execution
client_idle_timeout = 0                   # No client idle timeout
client_login_timeout = 60                 # Client login timeout
autodb_idle_timeout = 3600                # Auto-database idle timeout

# Memory and performance
max_packet_size = 2147483647              # 2GB max packet size
sbuf_loopcnt = 5                          # Server buffer loop count
tcp_defer_accept = 0                      # TCP defer accept
tcp_socket_buffer = 0                     # TCP socket buffer
tcp_keepalive = 1                         # Enable TCP keepalive
tcp_keepcnt = 3                           # TCP keepalive count
tcp_keepidle = 600                        # TCP keepalive idle time
tcp_keepintvl = 30                        # TCP keepalive interval

# Logging
log_connections = 1                       # Log connections
log_disconnections = 1                    # Log disconnections
log_pooler_errors = 1                     # Log pooler errors
log_stats = 1                             # Log statistics
stats_period = 60                         # Statistics period (seconds)

# Admin interface
admin_users = postgres                    # Admin users
stats_users = postgres                    # Statistics users

# Security
ignore_startup_parameters = extra_float_digits  # Ignore startup parameters

# Performance tuning
server_reset_query = DISCARD ALL          # Reset query
server_check_query = SELECT 1             # Health check query
server_check_delay = 30                   # Health check delay
server_lifetime = 3600                    # Server connection lifetime
server_idle_timeout = 600                 # Server idle timeout

# Connection limits per user
max_user_connections = 100                # Max connections per user

# Logging level
verbose = 0                               # Verbose logging level

# Additional enterprise settings
# Connection pooling optimization
pool_mode = transaction                   # Most efficient for web apps
max_client_conn = 1000                    # High concurrency support
default_pool_size = 50                    # Optimal pool size
min_pool_size = 10                        # Minimum connections
reserve_pool_size = 10                    # Reserve for critical operations
reserve_pool_timeout = 5                  # Quick reserve timeout

# Timeout optimization
server_connect_timeout = 15               # Fast connection timeout
server_login_retry = 15                   # Retry failed logins
query_timeout = 0                         # No query timeout (let app handle)
query_wait_timeout = 120                  # Wait for query execution
client_idle_timeout = 0                   # No client idle timeout
client_login_timeout = 60                 # Client login timeout
autodb_idle_timeout = 3600                # Auto-database idle timeout

# Memory optimization
max_packet_size = 2147483647              # Large packet support
sbuf_loopcnt = 5                          # Server buffer optimization
tcp_defer_accept = 0                      # No TCP defer accept
tcp_socket_buffer = 0                     # No TCP socket buffer
tcp_keepalive = 1                         # Enable TCP keepalive
tcp_keepcnt = 3                           # TCP keepalive count
tcp_keepidle = 600                        # TCP keepalive idle
tcp_keepintvl = 30                        # TCP keepalive interval

# Logging optimization
log_connections = 1                       # Log all connections
log_disconnections = 1                    # Log all disconnections
log_pooler_errors = 1                     # Log pooler errors
log_stats = 1                             # Enable statistics logging
stats_period = 60                         # Statistics every minute

# Admin and monitoring
admin_users = postgres                    # Admin users
stats_users = postgres                    # Statistics users
ignore_startup_parameters = extra_float_digits  # Ignore startup parameters

# Performance tuning
server_reset_query = DISCARD ALL          # Reset query for clean state
server_check_query = SELECT 1             # Simple health check
server_check_delay = 30                   # Health check every 30 seconds
server_lifetime = 3600                    # Server connection lifetime (1 hour)
server_idle_timeout = 600                 # Server idle timeout (10 minutes)

# Connection limits
max_user_connections = 100                # Max connections per user

# Logging level
verbose = 0                               # Normal logging level

# Additional enterprise optimizations
# Connection pooling for high availability
pool_mode = transaction                   # Transaction-level pooling
max_client_conn = 1000                    # Support 1000 concurrent clients
default_pool_size = 50                    # 50 connections per database
min_pool_size = 10                        # Always keep 10 connections
reserve_pool_size = 10                    # Reserve 10 connections
reserve_pool_timeout = 5                  # Quick reserve timeout

# Timeout management
server_connect_timeout = 15               # Fast connection timeout
server_login_retry = 15                   # Retry failed logins
query_timeout = 0                         # No query timeout
query_wait_timeout = 120                  # Wait for query execution
client_idle_timeout = 0                   # No client idle timeout
client_login_timeout = 60                 # Client login timeout
autodb_idle_timeout = 3600                # Auto-database idle timeout

# Memory management
max_packet_size = 2147483647              # Large packet support
sbuf_loopcnt = 5                          # Server buffer optimization
tcp_defer_accept = 0                      # No TCP defer accept
tcp_socket_buffer = 0                     # No TCP socket buffer
tcp_keepalive = 1                         # Enable TCP keepalive
tcp_keepcnt = 3                           # TCP keepalive count
tcp_keepidle = 600                        # TCP keepalive idle
tcp_keepintvl = 30                        # TCP keepalive interval

# Monitoring and logging
log_connections = 1                       # Log all connections
log_disconnections = 1                    # Log all disconnections
log_pooler_errors = 1                     # Log pooler errors
log_stats = 1                             # Enable statistics logging
stats_period = 60                         # Statistics every minute

# Administration
admin_users = postgres                    # Admin users
stats_users = postgres                    # Statistics users
ignore_startup_parameters = extra_float_digits  # Ignore startup parameters

# Performance optimization
server_reset_query = DISCARD ALL          # Reset query for clean state
server_check_query = SELECT 1             # Simple health check
server_check_delay = 30                   # Health check every 30 seconds
server_lifetime = 3600                    # Server connection lifetime (1 hour)
server_idle_timeout = 600                 # Server idle timeout (10 minutes)

# Connection management
max_user_connections = 100                # Max connections per user

# Logging configuration
verbose = 0                               # Normal logging level
