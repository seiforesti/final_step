# Simple Enterprise PostgreSQL Configuration
# Optimized for high-load data governance platform
# Compatible with PostgreSQL 15

# Connection Settings
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 5

# Memory Settings (Optimized for Enterprise Load)
shared_buffers = 512MB                    # 25% of 2GB RAM - critical for performance
effective_cache_size = 1536MB             # 75% of 2GB RAM - helps query planner
work_mem = 16MB                           # Increased for complex queries
maintenance_work_mem = 256MB              # Increased for maintenance operations

# Write-Ahead Logging (WAL) - Critical for Performance and Durability
wal_buffers = 32MB                        # Increased for better write performance
min_wal_size = 2GB                        # Minimum WAL size
max_wal_size = 8GB                        # Maximum WAL size
checkpoint_completion_target = 0.9        # Spread checkpoints over time
checkpoint_timeout = 10min                # Checkpoint interval
wal_compression = on                      # Compress WAL to save space
wal_log_hints = on                        # Log hint bits for better performance

# Query Planner Settings
random_page_cost = 1.1                    # SSD-optimized
effective_io_concurrency = 200            # Concurrent I/O operations
default_statistics_target = 100           # Better query planning

# Logging Configuration
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000         # Log slow queries
log_checkpoints = on                      # Log checkpoint activity
log_connections = on                      # Log connections
log_disconnections = on                   # Log disconnections
log_lock_waits = on                       # Log lock waits
log_temp_files = 0                        # Log temp file usage
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Autovacuum Settings (Critical for Performance)
autovacuum = on
autovacuum_max_workers = 4                # More workers for faster cleanup
autovacuum_naptime = 30s                  # Check every 30 seconds
autovacuum_vacuum_threshold = 25          # Vacuum when 25 rows changed
autovacuum_analyze_threshold = 25         # Analyze when 25 rows changed
autovacuum_vacuum_scale_factor = 0.1      # 10% of table size
autovacuum_analyze_scale_factor = 0.05    # 5% of table size
autovacuum_vacuum_cost_delay = 10ms       # Delay between vacuum operations
autovacuum_vacuum_cost_limit = 2000       # Cost limit for vacuum

# Background Writer
bgwriter_delay = 100ms                    # Write dirty pages more frequently
bgwriter_lru_maxpages = 200               # More pages per round
bgwriter_lru_multiplier = 2.0             # Adaptive background writing
bgwriter_flush_after = 512kB              # Flush after 512KB

# Client Connection Defaults
default_transaction_isolation = 'read committed'
default_transaction_read_only = off
default_transaction_deferrable = off
timezone = 'UTC'
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'
default_text_search_config = 'pg_catalog.english'

# Lock Management
deadlock_timeout = 500ms                  # Faster deadlock detection
max_locks_per_transaction = 128           # More locks per transaction
max_pred_locks_per_transaction = 64       # Predicate locks
max_pred_locks_per_relation = 64          # Per-relation predicate locks
max_pred_locks_per_page = 2               # Per-page predicate locks

# Statement Behavior
statement_timeout = 0                     # No statement timeout
lock_timeout = 0                          # No lock timeout
idle_in_transaction_session_timeout = 300000  # 5 minutes idle timeout

# Shared Memory and Semaphores
shared_preload_libraries = 'pg_stat_statements'  # Load statistics extension
dynamic_shared_memory_type = posix

# SSL Settings (disabled for development)
ssl = off

# Performance Schema
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
track_activity_query_size = 2048          # Larger query text tracking

# Statistics
pg_stat_statements.max = 10000            # Track more statements
pg_stat_statements.track = all            # Track all statements

# Additional Performance Tuning
enable_hashjoin = on                      # Enable hash joins
enable_mergejoin = on                     # Enable merge joins
enable_nestloop = on                      # Enable nested loop joins
enable_seqscan = on                       # Enable sequential scans
enable_sort = on                          # Enable sorting
enable_tidscan = on                       # Enable TID scans

# Parallel Query Settings
max_parallel_workers_per_gather = 2       # Parallel workers per gather
max_parallel_workers = 8                  # Total parallel workers
max_parallel_maintenance_workers = 2      # Parallel maintenance workers

# Vacuum and Analyze
vacuum_cost_delay = 0                     # No vacuum delay
vacuum_cost_page_hit = 1                  # Cost of page hit
vacuum_cost_page_miss = 10                # Cost of page miss
vacuum_cost_page_dirty = 20               # Cost of dirty page

# Error Reporting and Logging
log_min_messages = warning                # Log warnings and above
log_min_error_statement = error           # Log error statements

# Runtime Statistics
track_activity_query_size = 2048          # Track larger queries

# Additional Enterprise Optimizations
# Connection pooling hints
tcp_keepalives_idle = 600                 # TCP keepalive idle time
tcp_keepalives_interval = 30              # TCP keepalive interval
tcp_keepalives_count = 3                  # TCP keepalive count

# Memory management
huge_pages = try                          # Try to use huge pages
huge_page_size = 0                        # Auto-detect huge page size

# Advanced WAL settings
wal_writer_delay = 200ms                  # WAL writer delay
wal_writer_flush_after = 1MB              # WAL writer flush after
commit_delay = 0                          # No commit delay
commit_siblings = 5                       # Commit siblings threshold

# Checkpoint settings
checkpoint_warning = 30s                  # Checkpoint warning threshold
checkpoint_flush_after = 256kB            # Checkpoint flush after

# Lock timeout settings
lock_timeout = 0                          # No lock timeout
idle_in_transaction_session_timeout = 300000  # 5 minutes

# Statement timeout
statement_timeout = 0                     # No statement timeout

# Additional logging
log_autovacuum_min_duration = 0           # Log all autovacuum operations
log_temp_files = 0                        # Log temp file usage
log_lock_waits = on                       # Log lock waits
log_statement = 'none'                    # Don't log all statements
log_replication_commands = off            # Don't log replication commands

# Performance monitoring
track_io_timing = on                      # Track I/O timing
track_functions = all                     # Track all functions

# Additional enterprise settings
default_tablespace = ''                   # Use default tablespace
temp_tablespaces = ''                     # Use default temp tablespace
check_function_bodies = on                # Check function bodies
default_transaction_isolation = 'read committed'  # Default isolation level
default_transaction_read_only = off       # Default read/write
default_transaction_deferrable = off      # Default non-deferrable
session_replication_role = 'origin'       # Session replication role
statement_timeout = 0                     # No statement timeout
lock_timeout = 0                          # No lock timeout
idle_in_transaction_session_timeout = 300000  # 5 minutes
vacuum_freeze_min_age = 50000000          # Vacuum freeze minimum age
vacuum_freeze_table_age = 150000000       # Vacuum freeze table age
vacuum_multixact_freeze_min_age = 5000000 # Vacuum multixact freeze minimum age
vacuum_multixact_freeze_table_age = 150000000  # Vacuum multixact freeze table age
